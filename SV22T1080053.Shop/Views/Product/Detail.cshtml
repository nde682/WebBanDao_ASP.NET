@model SV22T1080053.DomainModels.Product
@using SV22T1080053.Shop.AppCodes
@{
    ViewData["Title"] = Model.ProductName;
    var categories = ViewBag.Categories as IEnumerable<SV22T1080053.DomainModels.Category>;
    var listPhotos = ViewBag.Photos as IEnumerable<SV22T1080053.DomainModels.ProductPhoto>;
    var listAttributes = ViewBag.Attributes as IEnumerable<SV22T1080053.DomainModels.ProductAttribute>;
    var slideImages = new List<string>();

    // 1. Thêm ảnh chính (Nếu có)
    if (!string.IsNullOrEmpty(Model.Photo))
    {
        slideImages.Add($"{ApplicationContext.ProductImagePath}{Model.Photo}");
    }
    else
    {
        slideImages.Add($"{ApplicationContext.ProductImagePath}NOimages.png");
    }

    if (listPhotos != null)
    {
        foreach (var p in listPhotos.Where(x => !x.IsHidden).OrderBy(x => x.DisplayOrder))
        {
            // Kiểm tra đường dẫn ảnh phụ
            if (!string.IsNullOrEmpty(p.Photo))
            {
                slideImages.Add($"{ApplicationContext.ProductImagePath}{p.Photo}");
            }
        }
    }
}

<div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6 wow fadeInUp" data-wow-delay="0.1s">@Model.ProductName</h1>
    <ol class="breadcrumb justify-content-center mb-0 wow fadeInUp" data-wow-delay="0.3s">
        <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="~/Shop">Cửa hàng</a></li>
        <li class="breadcrumb-item active text-white">Chi tiết</li>
    </ol>
</div>

<div class="container-fluid shop py-5 to">
    <div class="container py-5">
        <div class="row g-4">

            <div class="col-lg-5 col-xl-3 wow fadeInUp" data-wow-delay="0.1s">
                
                <div class="product-categories mb-4">
                    <h4>Danh mục sản phẩm</h4>
                    <ul class="list-unstyled">
                        <li><a href="~/Shop" class="text-dark"><i class="fas fa-apple-alt text-secondary me-2"></i> Tất cả</a></li>
                        @if (categories != null)
                        {
                            foreach (var cat in categories)
                            {
                                <li>
                                    <div class="categories-item">
                                        <a href="~/Shop?categoryID=@cat.CategoryID" class="text-dark">
                                            <i class="fas fa-apple-alt text-secondary me-2"></i> @cat.CategoryName
                                        </a>
                                    </div>
                                </li>
                            }
                        }
                    </ul>
                </div>
            </div>

            <div class="col-lg-7 col-xl-9 wow fadeInUp" data-wow-delay="0.1s">
                <div class="row g-4 single-product">

                    <div class="col-xl-6">
                        <div class="single-carousel owl-carousel">
                            @foreach (var imgSrc in slideImages)
                            {
                                <div class="single-item" data-dot="<img class='img-fluid' src='@imgSrc' alt=''>">
                                    <div class="single-inner bg-light rounded">
                                        <img src="@imgSrc" class="img-fluid rounded" alt="@Model.ProductName">
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="col-xl-6">
                        <h4 class="fw-bold mb-3">@Model.ProductName</h4>

                        <p class="mb-3 text-muted">Đơn vị tính: <strong>@Model.Unit</strong></p>

                        @if (listAttributes != null && listAttributes.Any())
                        {
                            <div class="mb-3 rounded">
                                <h6 class="fw-bold mb-2">Thông số kỹ thuật:</h6>
                                <table class="table table-sm table-borderless small mb-0">
                                    @foreach (var attr in listAttributes.OrderBy(x => x.DisplayOrder))
                                    {
                                        <tr>
                                            <td style="width: 40%; font-weight: 600; color: #555;">@attr.AttributeName:</td>
                                            <td>@attr.AttributeValue</td>
                                        </tr>
                                    }
                                </table>
                            </div>
                        }

                        <h5 class="fw-bold mb-3 text-primary display-6">@Model.Price.ToString("N0") ₫</h5>

                        <p class="mb-4">@Model.ProductDescription</p>

                        <div class="input-group quantity mb-4" style="width: 130px;">
                            <div class="input-group-btn">
                                <button class="btn btn-minus rounded-circle bg-light border"><i class="fa fa-minus"></i></button>
                            </div>
                            <input type="text" id="txtQuantity" class="form-control text-center border-0" value="1">
                            <div class="input-group-btn">
                                <button class="btn btn-plus rounded-circle bg-light border"><i class="fa fa-plus"></i></button>
                            </div>
                        </div>

                        <a href="javascript:;" onclick="addToCartDetail(@Model.ProductID)"
                           class="btn btn-primary border border-secondary rounded-pill px-5 py-3 mb-4 text-white">
                            <i class="fa fa-shopping-bag me-2 text-white"></i> Thêm vào giỏ
                        </a>
                    </div>

                    <div class="col-lg-12">
                        <div class="tab-content mb-5">
                            <div class="tab-pane active" id="nav-about">
                                <h5 class="mb-3">Mô tả chi tiết sản phẩm:</h5>
                                <p>@Model.ProductDescription</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
         $(document).ready(function () {
            showCartInfo();
            setTimeout(function () {
            $('html, body').animate({
            scrollTop: $(".to").offset().top
            }, 100, 'easeInOutExpo');
            }, 500);  
        })
        // Hàm thêm vào giỏ
        function addToCartDetail(id) {
            var quantity = $("#txtQuantity").val();
            $.ajax({
                url: "/Cart/AddToCart",
                type: "POST",
                data: { id: id, quantity: quantity },
                success: function (response) {
                    showCartInfo();
                    alert("Đã thêm " + quantity + " sản phẩm vào giỏ hàng!");
                },
                error: function () {
                    alert("Lỗi thêm giỏ hàng.");
                }
            });
        }
        function showCartInfo() {
            $.ajax({
                url: "/Cart/GetCartInfo",
                type: "GET",
                success: function (data) {
                    if (data.count > 0) {
                        $("#cart-global-count").text(data.count).show();
                    } else {
                        $("#cart-global-count").hide();
                    }
                    var formattedTotal = data.total.toLocaleString('vi-VN') + " ₫";
                    $("#cart-global-total").text(formattedTotal);
                },
                error: function () {
                    console.log("Không thể tải thông tin giỏ hàng");
                }
            });
        }

    </script>
}